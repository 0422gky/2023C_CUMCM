# 2023国赛C题第二问最优化代码
主要放的是Q2的代码，因为是问题的核心，也就是Q2当中optimize的部分
仓库文件目录与实际代码文件目录无关）

## Q2_optimize.py

本节总结 `Q2_optimize.py` 的代码思路、输入/输出、假设与运行方法，方便复现与维护。

主要目标
- 使用前面回归得到的价格—销量关系（线性或对数线性模型），为每一类商品计算“最优价格”。

输入
- `linear_regression_results.csv` 或 `loglog_regression_results.csv`：包含每个分类回归系数（截距与斜率）和统计信息。
- `file_23_pq.csv`（或类似的历史 P/Q 数据文件）：用于确定每个分类的历史价格范围和基准价格分布。

输出
- `optimal_prices.csv`：每个分类的最优价格、对应的预测销量与预测收入（或收益）等。
- 若启用绘图：每类的价格—销量散点图与最优价格标注图（可选，保存在 `Q2_products/` 下）。

核心思路（算法概览）
1. 从回归结果读取模型形式与系数。常见两类模型：
	- 线性模型：Q(P) = a + b * P
	- 对数模型（log-log）：log Q = alpha + beta * log P  ⇔  Q(P) = c * P^{beta}
2. 定义目标函数（常用）：预测收入 R(P) = P * Q(P)。也可扩展为利润函数（如果有单位成本 c0）：π(P) = (P - c0) * Q(P)。
3. 对每一类，尝试解析求解最优解：
	- 线性模型下，R(P) = P(a + bP) ⇒ 对 P 求导得 $$P^* = \frac{b P_{avg} + b C_{eff}+Q_{base}}{2b}, $$
	- 对数模型下，$ Q(P)=c P^{beta} ⇒ R(P)=c P^{1+beta} $ ，当 $1+beta ≠ 0$ 时，R(P) 单调（除非在边界），解析极值通常在边界或不存在；因此常用数值方法或网格搜索,这也是对数模型预测不准确的主要原因。
4. 若解析解不存在或不可信（超出历史/业务边界、导致负销量等），使用受限网格搜索：
	- 以历史价格分布为中心，确定合理搜索区间（例如 [P_5pct, P_95pct] 或 基准价格 × [0.6, 1.6]）。
	- 在该区间上对目标函数进行细化网格搜索，取最优点并检查销量非负且业务合理。
5. 对候选最优解进行简单验证：销量 >= 0、价格在业务上下限内、优化后收益确实提升（相较于历史均值）。

实现细节与防护措施
- 对回归系数的有效性做基本筛查：斜率为 0、样本量过小或 R^2 极低时，应退回到保守策略（例如使用历史均价或使用网格搜索并限制幅度）。
- 价格与销量的物理边界检查（销量不能为负，价格必须大于成本/最低限价）。
- 在网格搜索中保留若干候选（如 top-3）以供后续人工/业务规则筛选。
- 可以将单位成本作为可选参数传入，以计算利润最大化而非仅仅最大化收入。

如何运行
1. 确保已生成或放置好回归结果文件（`linear_regression_results.csv` 或 `loglog_regression_results.csv`）与历史 P/Q 数据文件（`file_23_pq.csv`）。
2. 安装依赖（如果尚未安装）：

```powershell
pip install pandas numpy matplotlib seaborn
```

3. 运行脚本（在项目根目录）：

```powershell
python Q2_optimize.py
```

输出 `optimal_prices.csv` 将写入当前目录（脚本中可配置输出路径）；若启用绘图，图像会保存到 `Q2_products/` 或脚本配置的目录。
